.script_template: &script_definition
  script:
    - |
      #
      #  NOTES:  WORKDIR is on constance/marianas/newell
      #          ./      is only on the Kubernetes instance
      #
      set -xv
      export WORKDIR="$HOME/gitlab/$CI_JOB_ID/"
      mkdir -p "$WORKDIR"
      cp -a ./ "$WORKDIR"
      cd "$WORKDIR"
      touch output
      tail -f output &
      tailpid=$!
      sbatch -A EXASGD --export=MY_CLUSTER=$CLUSTER -p $SLURM_Q -t 1:00:00 --gres=gpu:1 -o output -e output $WORKDIR/BUILD.sh
      res=1
      set +xv
      while :;
        do
        if [[ "$(awk 'BEGIN{i=0}/BUILD_STATUS/{i++}END{print i}' output)" != "0" ]]; then
          kill $tailpid
          res=$(grep BUILD_STATUS output | tail -n 1 | cut -f2 -d':')
          break
        fi
        sleep 10
      done
      echo "finished batch job: $res"
      # cat output
      #
      #  NOTE:  If the job fails, comment out the line below and cd to
      #         $HOME/gitlab/$CI_JOB_ID and run ./build.sh by hand to
      #         figure out what went wrong.
      # cd $WORKDIR
      # ./BUILD.sh
      #
      rm -rf "$WORKDIR"
      exit $res


.tags_template: &tags_definition
  tags:
    - k8s
    - ikp
    - exasgd
    - marianas


build_on_marianas:
  stage: build
  variables:
    SLURM_Q: "dl"
    CLUSTER: "marianas"
  <<: *tags_definition
  <<: *script_definition
  only:
    - branches@exasgd/solvers/hiop


build_on_newell:
  stage: build
  variables:
    SLURM_Q: "newell_shared"
    CLUSTER: "newell"
  <<: *tags_definition
  <<: *script_definition
  only:
    - branches@exasgd/solvers/hiop
